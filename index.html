<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8' />
    <title>Mapbox Storytelling</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link rel="icon" type="image/x-icon"
        href="https://raw.githubusercontent.com/mapbox/assembly/publisher-staging/src/svgs/mapbox.svg">
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v3.8.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v3.8.0/mapbox-gl.css' rel='stylesheet' />
    <script src="https://cdn.jsdelivr.net/npm/mapbox-gl-globe-minimap@1.2.0/dist/bundle.js"></script>
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script> 
    <script src="https://unpkg.com/scrollama"></script>
    <style>
        :root {
            --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
        }
        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-sans);
        }

        #legend-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100; /* Ensure it's above other elements */
        }

        .legend {
            background-color: #fff;
            border-radius: 3px;
            bottom: 20px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            font-family: var(--font-sans);
            font-size: 12px;
            line-height: 20px;
            padding: 10px;
            position: fixed;
            right: 10px;
            z-index: 1000;
            pointer-events: none; /* do not block map hover */
        }
        .legend h4 {margin: 0 0 8px;}
        .legend .gradient-wrap { width: 220px; }
        .legend .gradient-bar {
            width: 100%;
            height: 12px;
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.15);
            background: linear-gradient(to right,
                #00308a 0%,
                #0b4fb3 20%,
                #3a84df 35%,
                #7fb6ff 45%,
                #800080 50%,
                #f3b8c3 60%,
                #d3586d 75%,
                #cc2f4a 88%,
                #b20020 100%
            );
        }
        .legend .ticks {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 11px;
            opacity: 0.9;
        }
        .legend .ticks span { flex: 1; text-align: center; }

        a,
        a:hover,
        a:visited {
            color: #0071bc;
        }

        #map {
            top: 0;
            height: 100vh;
            width: 100vw;
            position: fixed;
        }

        /* Top state menu */
        .menu-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 8px;
            gap: 8px;
            overflow-x: auto;
            background: rgba(0, 0, 0, 0.55);
            backdrop-filter: blur(6px);
            z-index: 1002;
        }
        .menu-item {
            font-family: var(--font-sans);
            font-size: 13px;
            color: #fff;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.25);
            border-radius: 6px;
            padding: 6px 10px;
            white-space: nowrap;
            cursor: pointer;
        }
        .menu-item:hover { background: rgba(255,255,255,0.12); }
        /* Offset story content so menu does not overlap hero/header */
        #story { padding-top: 52px; }

        #header {
            margin: auto;
            width: 100%;
            position: relative;
            z-index: 5;
        }

        #header h1,
        #header h2,
        #header p {
            margin: 0;
            padding: 2vh 2vw;
            text-align: center;
        }

        #footer {
            width: 100%;
            min-height: 5vh;
            padding-top: 2vh;
            padding-bottom: 2vh;
            text-align: center;
            line-height: 25px;
            font-size: 13px;
            position: relative;
            z-index: 5;
        }

        #features {
            padding-top: 10vh;
            padding-bottom: 10vh;
        }

        .hidden {
            visibility: hidden;
        }

        .centered {
            width: 50vw;
            margin: 0 auto;
        }

        .lefty {
            width: 33vw;
            margin-left: 5vw;
        }

        .righty {
            width: 33vw;
            margin-left: 62vw;
        }

        .fully {
            width: 100%;
            margin: auto;
        }

        .light {
            color: #444;
            background-color: #fafafa;
        }

        .dark {
            color: #fafafa;
            background-color: #444;
        }

        .step {
            padding-bottom: 50vh;
            /* margin-bottom: 10vh; */
            opacity: 0.25;
            scroll-margin-top: 60px; /* avoid being covered by fixed menu */
        }

        .step.active {
            opacity: 0.9;
        }

        .step div {
            padding: 25px 50px;
            line-height: 25px;
            font-size: 13px;
        }

        .pie {
            width: 140px;
            height: 140px;
            aspect-ratio: 1 / 1;
            border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.6);
            box-shadow: inset 0 0 0 1px rgba(0,0,0,0.25);
            display: block;
            flex: 0 0 140px; /* prevent flex stretch/shrink */
        }

        @media (max-width: 750px) {

            .centered,
            .lefty,
            .righty,
            .fully {
                width: 90vw;
                margin: 0 auto;
            }
        }

        /* Fix issue on mobile browser where scroll breaks  */
        .mapboxgl-canvas-container.mapboxgl-touch-zoom-rotate.mapboxgl-touch-drag-pan,
        .mapboxgl-canvas-container.mapboxgl-touch-zoom-rotate.mapboxgl-touch-drag-pan .mapboxgl-canvas {
            touch-action: unset;
        }
    </style>
</head>
    
    <body>

        <div id="map"></div>
        <nav id="state-menu" class="menu-bar" aria-label="State navigation"></nav>
        <div class="legend" id="pop-legend">
            <h4>Vote Lean</h4>
            <div class="gradient-wrap">
                <div class="gradient-bar" aria-label="Democrat to Republican gradient"></div>
                <div class="ticks">
                    <span>More Dem</span>
                    <span>50/50</span>
                    <span>More GOP</span>
                </div>
            </div>
        </div>
    <div id="story"
    
    
    ></div>

    <script src="./config.js"></script>
    <script>
        var initLoad = true;
        var layerTypes = {
            'fill': ['fill-opacity'],
            'line': ['line-opacity'],
            'circle': ['circle-opacity', 'circle-stroke-opacity'],
            'symbol': ['icon-opacity', 'text-opacity'],
            'raster': ['raster-opacity'],
            'fill-extrusion': ['fill-extrusion-opacity'],
            'heatmap': ['heatmap-opacity']
        }

        var alignments = {
            'left': 'lefty',
            'center': 'centered',
            'right': 'righty',
            'full': 'fully'
        }

        function getLayerPaintType(layer) {
            var layerType = map.getLayer(layer).type;
            return layerTypes[layerType];
        }

        function setLayerOpacity(layer) {
            var paintProps = getLayerPaintType(layer.layer);
            paintProps.forEach(function (prop) {
                var options = {};
                if (layer.duration) {
                    var transitionProp = prop + "-transition";
                    options = { "duration": layer.duration };
                    map.setPaintProperty(layer.layer, transitionProp, options);
                }
                map.setPaintProperty(layer.layer, prop, layer.opacity, options);
            });
        }

        var story = document.getElementById('story');
        var features = document.createElement('div');
        features.setAttribute('id', 'features');

        var header = document.createElement('div');

        if (config.title) {
            var titleText = document.createElement('h1');
            titleText.innerText = config.title;
            header.appendChild(titleText);
        }

        if (config.subtitle) {
            var subtitleText = document.createElement('h2');
            subtitleText.innerText = config.subtitle;
            header.appendChild(subtitleText);
        }

        if (config.byline) {
            var bylineText = document.createElement('p');
            bylineText.innerText = config.byline;
            header.appendChild(bylineText);
        }

        if (header.innerText.length > 0) {
            header.classList.add(config.theme);
            header.setAttribute('id', 'header');
            story.appendChild(header);
        }

        // Build chapters after loading state results and replacing images with state graphics (waffle chart)
        function buildChaptersWithCharts(stateTotals) {
            config.chapters.forEach((record, idx) => {
                var container = document.createElement('div');
                var chapter = document.createElement('div');

                // Derive state code from chapter id prefix (e.g., OHChoro, AZDot)
                var stateCode = (record.id || '').slice(0, 2).toUpperCase();
                var codeToName = {
                    AZ: 'Arizona',
                    GA: 'Georgia',
                    MI: 'Michigan',
                    NC: 'North Carolina',
                    NV: 'Nevada',
                    OH: 'Ohio',
                    PA: 'Pennsylvania',
                    WI: 'Wisconsin'
                };

                // Add state name heading above the chapter's title (date/time)
                if (codeToName[stateCode]) {
                    var stateHeader = document.createElement('h2');
                    stateHeader.innerText = codeToName[stateCode];
                    chapter.appendChild(stateHeader);
                }

                if (record.title) {
                    var title = document.createElement('h3');
                    title.innerText = record.title;
                    chapter.appendChild(title);
                }

                // Replace images with a waffle chart (10x10 grid) of state results
                // Use totals derived from swingstatedata.geojson (DEM vs GOP)
                var totals = stateTotals[stateCode];
                if (totals) {
                    var wrap = document.createElement('div');
                    wrap.style.display = 'flex';
                    wrap.style.alignItems = 'center';
                    wrap.style.gap = '12px';
                    wrap.style.margin = '8px 0 4px 0';

                    var demShare = totals.dem / Math.max(1, (totals.dem + totals.gop));
                    var gopShare = 1 - demShare;
                    var demAngle = (demShare * 360).toFixed(1);

                    var pie = document.createElement('div');
                    pie.className = 'pie';
                    pie.style.background = `conic-gradient(#1666CB 0deg ${demAngle}deg, #CC2F4A ${demAngle}deg 360deg)`;

                    var legend = document.createElement('div');
                    legend.style.fontSize = '13px';
                    legend.style.lineHeight = '18px';
                    var demPct = (demShare * 100).toFixed(1);
                    var gopPct = (gopShare * 100).toFixed(1);
                    legend.innerHTML = `
                        <div><span style="display:inline-block;width:10px;height:10px;background:#1666CB;border-radius:2px;margin-right:6px"></span>Democrat ${demPct}%</div>
                        <div><span style="display:inline-block;width:10px;height:10px;background:#CC2F4A;border-radius:2px;margin-right:6px"></span>Republican ${gopPct}%</div>
                    `;

                    wrap.appendChild(pie);
                    wrap.appendChild(legend);
                    chapter.appendChild(wrap);
                }

                if (record.description) {
                    var desc = document.createElement('p');
                    desc.innerHTML = record.description;
                    chapter.appendChild(desc);
                }

                container.setAttribute('id', record.id);
                container.classList.add('step');
                if (idx === 0) {
                    container.classList.add('active');
                }

                chapter.classList.add(config.theme);
                container.appendChild(chapter);
                container.classList.add(alignments[record.alignment] || 'centered');
                if (record.hidden) {
                    container.classList.add('hidden');
                }
                features.appendChild(container);
            });

            story.appendChild(features);

            // Signal that chapters are built so the footer can be appended afterward
            if (typeof document !== 'undefined' && document && typeof CustomEvent !== 'undefined') {
                document.dispatchEvent(new CustomEvent('chapters-built'));
            }
        }

        // Load county results and aggregate to state totals, then build chapters
        (function initChapters() {
            const fipsToCode = { '4':'AZ','04':'AZ','13':'GA','26':'MI','32':'NV','37':'NC','39':'OH','42':'PA','55':'WI' };
            fetch('swingstatedata.geojson')
                .then(r => r.json())
                .then(geo => {
                    const totals = {};
                    geo.features.forEach(f => {
                        const p = (f && f.properties) || {};
                        const stateKey = String(p.STATEFP);
                        const code = fipsToCode[stateKey] || null;
                        if (!code) return;
                        const g = Number(p.votes_gop) || 0;
                        const d = Number(p.votes_dem) || 0;
                        if (!totals[code]) totals[code] = { gop: 0, dem: 0 };
                        totals[code].gop += g;
                        totals[code].dem += d;
                    });
                    buildChaptersWithCharts(totals);
                })
                .catch(() => {
                    // Fallback: build chapters without charts if data fails to load
                    buildChaptersWithCharts({});
                });
        })();

        // Helper to programmatically activate a chapter without scrolling the story
        function activateChapter(chapter) {
            if (!chapter) return;
            map[chapter.mapAnimation || 'flyTo'](chapter.location);
            if (config.showMarkers && typeof marker !== 'undefined' && marker) {
                marker.setLngLat(chapter.location.center);
            }
            if (Array.isArray(chapter.onChapterEnter) && chapter.onChapterEnter.length > 0) {
                chapter.onChapterEnter.forEach(setLayerOpacity);
            }
            if (chapter.callback && typeof window[chapter.callback] === 'function') {
                window[chapter.callback]();
            }
            if (chapter.rotateAnimation) {
                map.once('moveend', () => {
                    const rotateNumber = map.getBearing();
                    map.rotateTo(rotateNumber + 180, {
                        duration: 30000,
                        easing: function (t) { return t; }
                    });
                });
            }
        }

        // Build state menu from chapters that represent states (e.g., *Choro chapters)
        (function buildStateMenu() {
            var menu = document.getElementById('state-menu');
            if (!menu) return;
            var codeToName = {
                AZ: 'Arizona',
                GA: 'Georgia',
                MI: 'Michigan',
                NC: 'North Carolina',
                NV: 'Nevada',
                OH: 'Ohio',
                PA: 'Pennsylvania',
                WI: 'Wisconsin'
            };
            var added = new Set();
            config.chapters.forEach(function(ch) {
                if (!ch || !ch.id) return;
                if (!/Choro$/.test(ch.id)) return; // use the first chapter for each state
                var code = (ch.id.slice(0,2) || '').toUpperCase();
                if (!code || added.has(code)) return;
                added.add(code);
                var label = codeToName[code] || code;
                var btn = document.createElement('button');
                btn.className = 'menu-item';
                btn.type = 'button';
                btn.textContent = label;
                btn.addEventListener('click', function() {
                    // Jump to the chapter content instantly (no smooth scroll)
                    var el = document.getElementById(ch.id);
                    if (el) el.scrollIntoView({ behavior: 'auto', block: 'start' });
                    // And fly the map to the chapter's location
                    activateChapter(ch);
                });
                menu.appendChild(btn);
            });
        })();

        var footer = document.createElement('div');
        if (config.footer) {
            var footerText = document.createElement('p');
            footerText.innerHTML = config.footer;
            footer.appendChild(footerText);
        }
        if (footer.innerText.length > 0) {
            footer.classList.add(config.theme);
            footer.setAttribute('id', 'footer');
            // Append after chapters are created
            document.addEventListener('chapters-built', function () {
                // Remove any existing instance and append at the end
                var existingFooter = document.getElementById('footer');
                if (existingFooter && existingFooter.parentElement) {
                    existingFooter.parentElement.removeChild(existingFooter);
                }
                story.appendChild(footer);
            });
        }

        mapboxgl.accessToken = 'pk.eyJ1Ijoib21ja2Vhcm51dyIsImEiOiJjbTFqamRqeWcxMWF6MnJwc2RkdjBqdHoxIn0.E5gopEUreChvdj15aNY6_g';

        var map = new mapboxgl.Map({
            container: 'map',
            style: config.style,
            center: config.chapters[0].location.center,
            zoom: config.chapters[0].location.zoom,
            bearing: config.chapters[0].location.bearing,
            pitch: config.chapters[0].location.pitch,
            interactive: true,
            projection: config.projection
        });

        // Disable user panning/zooming/rotation; keep interactivity for popups
        map.dragPan.disable();
        map.scrollZoom.disable();
        map.boxZoom.disable();
        map.dragRotate.disable();
        map.keyboard.disable();
        map.doubleClickZoom.disable();
        map.touchZoomRotate.disable();

        // Create a inset map if enabled in config.js
        if (config.inset) {
            map.addControl(
                new GlobeMinimap({ ...config.insetOptions }),
                config.insetPosition
            );
        }

        if (config.showMarkers) {
            var marker = new mapboxgl.Marker({ color: config.markerColor });
            marker.setLngLat(config.chapters[0].location.center).addTo(map);
        }

        // instantiate the scrollama
        var scroller = scrollama();


        // List of selected swing state fips codes
        const selectedStateNumbers = [
            '13', // Georgia
            '37', // North Carolina
            '42', // Pennsylvania
            '55', // Wisconsin
            '39', // Ohio
            '26', // Michigan
            '32', // Nevada
            '4'   // Arizona
        ];

        map.on("load", function () {


            fetch('merged_election_results.geojson')
                .then(response => response.json())
                .then((data) => {
                    
                    // Filter the data to include selected swing states
                    const filteredData = data.features.filter(feature =>
                        selectedStateNumbers.includes(feature.properties.state_name)
                    );

                    // Add county borders layer for selected states
                    map.addSource('county-borders', {
                        type: 'geojson',
                        data: { type: 'FeatureCollection', features: filteredData }
                    });



                    // Add line layer for county borders in swing states
                    map.addLayer({
                        id: 'county-lines',
                        type: 'line',
                        source: 'county-borders',
                        paint: {
                            'line-color': 'black', 
                            'line-width': 5
                        }
                    });

                    const stateCentroids = {
                        type: 'FeatureCollection',
                        features: filteredData.map(feature => {
                            const state = feature.properties.state_name; 
                            const votes = feature.properties.total_votes || 0; 
                            const gopPercent = feature.properties.per_gop || 0; // GOP percentage
                            const demPercent = feature.properties.per_dem || 0; // dem percentage

                            const per_gop = gopPercent / (gopPercent + demPercent); // recalculate percent to get rid of third party


                            // find centroid
                            const centroid = turf.centroid(feature);

                            // Create a new feature with centroid geometry and properties
                            return {
                                type: 'Feature',
                                geometry: centroid.geometry,
                                properties: {
                                    state: state,
                                    total_votes: votes,
                                    per_gop: per_gop
                                }
                            };
                        })
                    };

                    map.addSource('state-centroids', {
                        type: 'geojson',
                        data: stateCentroids
                    });

                    // Add circle layer for centroids
                    map.addLayer({
                        id: 'circle-layer',
                        type: 'circle',
                        source: 'state-centroids',
                        paint: {
                            // Circle size based on total_votes
                            'circle-radius': [
                                'interpolate',
                                ['linear'],
                                ['get', 'total_votes'],
                                1000, 12,    
                                1000000, 60 
                            ],
                            // Circle color based on per_gop
                            'circle-color': [
                                'interpolate',
                                ['linear'],
                                ['get', 'per_gop'],
                                0, '#002B84',  // colors from https://en.wikipedia.org/wiki/Wikipedia:WikiProject_Elections_and_Referendums/USA_legend_colors
                                0.2, '#0645B4', 
                                0.3, '#1666CB', 
                                0.4, '#86B6F2', 
                                0.5, '#B9D7FF', 
                                0.55, '#800080',
                                0.6, '#FFDFE1', 
                                0.7, '#F2B3BE', 
                                0.8, '#CC2F4A', 
                                0.9, '#D40000', 
                                1, '#FF0000',   // red 
                            ],
                            'circle-opacity': 1,
                            'circle-stroke-width': 1.5,
                            'circle-stroke-color': '#FFFFFF'
                        }
                    });
                })


                

            // Add swing counties source with promoteId for feature-state highlighting
            map.addSource('swing-counties', {
                type: 'geojson',
                data: 'swingstatedata.geojson',
                promoteId: 'GEOID'
            });

            // Base fill layer for county results
            map.addLayer({
                id: 'county_results',
                type: 'fill',
                source: 'swing-counties',
                paint: {
                    'fill-color': [
                        'interpolate',
                        ['linear'],
                        ['/', 
                            ['coalesce', ['get', 'per_gop'], 0],  
                            ['+', 
                                ['coalesce', ['get', 'per_gop'], 0],  
                                ['coalesce', ['get', 'per_dem'], 0],
                            ]
                        ],
                        0, '#002B84',
                        0.2, '#0645B4', 
                        0.3, '#1666CB', 
                        0.4, '#86B6F2', 
                        0.5, '#B9D7FF', 
                        0.55, '#800080',
                        0.6, '#FFDFE1', 
                        0.7, '#F2B3BE', 
                        0.8, '#CC2F4A', 
                        0.9, '#D40000', 
                        1, '#FF0000',
                    ],
                    'fill-outline-color': 'grey'
                }
            });

            // Build county border lines from polygons for proper stroked highlights
            fetch('swingstatedata.geojson')
                .then(r => r.json())
                .then(geo => {
                    const borderFeatures = [];
                    geo.features.forEach(f => {
                        const out = turf.polygonToLine(f);
                        if (!out) return;
                        const attach = (feat) => {
                            if (!feat || feat.type !== 'Feature') return;
                            feat.properties = feat.properties || {};
                            const gid = f.properties && f.properties.GEOID;
                            if (gid != null) {
                                feat.properties.GEOID = gid;
                                feat.id = gid; // ensure feature-state id matches
                            }
                            borderFeatures.push(feat);
                        };
                        if (out.type === 'FeatureCollection' && Array.isArray(out.features)) {
                            out.features.forEach(attach);
                        } else {
                            attach(out);
                        }
                    });
                    const borderFC = { type: 'FeatureCollection', features: borderFeatures };

                    map.addSource('swing-county-borders', {
                        type: 'geojson',
                        data: borderFC,
                        promoteId: 'GEOID'
                    });

                    // Base thin borders
                    map.addLayer({
                        id: 'county_borders_base',
                        type: 'line',
                        source: 'swing-county-borders',
                        paint: {
                            'line-color': 'grey',
                            'line-width': 1,
                            'line-opacity': 0.7
                        }
                    });

                    // Highlight outline for hover/selected counties
                    map.addLayer({
                        id: 'county_highlight',
                        type: 'line',
                        source: 'swing-county-borders',
                        paint: {
                            'line-color': '#FFD400',
                            'line-width': [
                                'case',
                                ['boolean', ['feature-state', 'selected'], false], 4,
                                ['boolean', ['feature-state', 'hover'], false], 3,
                                0
                            ],
                            'line-opacity': [
                                'case',
                                ['boolean', ['feature-state', 'selected'], false], 1,
                                ['boolean', ['feature-state', 'hover'], false], 1,
                                0
                            ]
                        }
                    });
                });


            

            map.addLayer({
                id: 'national_results',
                type: 'fill',
                'source':  {type: 'geojson',
                    data: 'merged_election_results.geojson'
                    },                        
                    paint: {
                        'fill-color': [
                            'interpolate',
                            ['linear'],
                            ['/', 
                                ['coalesce', ['get', 'per_gop'], 0],  // Default per_gop to 0 if missing
                                ['+', 
                                    ['coalesce', ['get', 'per_gop'], 0],  // Default per_gop to 0 if missing
                                    ['coalesce', ['get', 'per_dem'], 0],
                                ]
                            ],
                            0, '#002B84',  // colors from https://en.wikipedia.org/wiki/Wikipedia:WikiProject_Elections_and_Referendums/USA_legend_colors
                                0.2, '#0645B4', 
                                0.3, '#1666CB', 
                                0.4, '#86B6F2', 
                                0.5, '#B9D7FF', 
                                0.55, '#800080',
                                0.6, '#FFDFE1', 
                                0.7, '#F2B3BE', 
                                0.8, '#CC2F4A', 
                                0.9, '#D40000', 
                                1, '#FF0000',
                        ],
                        'fill-outline-color': 'grey'
                    }
            });

            // Ensure the stroke highlight renders above all fills
            try { map.moveLayer('county_highlight'); } catch(e) {}

            // Interactions: hover and click popups for swing-state counties
            const hoverPopup = new mapboxgl.Popup({
                closeButton: false,
                closeOnClick: false,
                offset: 12
            });

            function formatNumber(n) {
                if (typeof n !== 'number') return 'N/A';
                return n.toLocaleString();
            }

            function formatPct(x) {
                if (typeof x !== 'number') return 'N/A';
                return (x * 100).toFixed(1) + '%';
            }

            function countyHTML(p) {
                const total = typeof p.total_votes === 'number' ? p.total_votes : null;
                const gop = typeof p.votes_gop === 'number' ? p.votes_gop : null;
                const dem = typeof p.votes_dem === 'number' ? p.votes_dem : null;
                const indVotes = (total != null && gop != null && dem != null) ? Math.max(total - gop - dem, 0) : null;

                const perG = typeof p.per_gop === 'number' ? p.per_gop : null;
                const perD = typeof p.per_dem === 'number' ? p.per_dem : null;
                const perI = (perG != null && perD != null) ? Math.max(1 - (perG + perD), 0) : null;

                const countyName = p.county_name || p.NAME || 'County';
                const population = p.population || p.POPULATION || null; // dataset may not include

                return `
                    <div style="min-width:220px; font-family: var(--font-sans);">
                        <div style="font-weight:600; margin-bottom:4px;">${countyName}</div>
                        <div style="font-size:12px; line-height:1.4;">
                            <div><strong>Population:</strong> ${population ? formatNumber(population) : 'N/A'}</div>
                            <div><strong>Total votes:</strong> ${formatNumber(total)}</div>
                            <div><strong>Dem votes:</strong> ${formatNumber(dem)} ${perD!=null?`(${formatPct(perD)})`:''}</div>
                            <div><strong>GOP votes:</strong> ${formatNumber(gop)} ${perG!=null?`(${formatPct(perG)})`:''}</div>
                            <div><strong>Independent:</strong> ${indVotes!=null?formatNumber(indVotes):'N/A'} ${perI!=null?`(${(perI*100).toFixed(1)}%)`:''}</div>
                        </div>
                    </div>
                `;
            }

            let hoveredId = null;
            let selectedId = null;

            map.on('mouseenter', 'county_results', () => {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', 'county_results', () => {
                map.getCanvas().style.cursor = '';
                hoverPopup.remove();
                if (hoveredId !== null) {
                    map.setFeatureState({ source: 'swing-county-borders', id: hoveredId }, { hover: false });
                    hoveredId = null;
                }
            });
            map.on('mousemove', 'county_results', (e) => {
                const f = e.features && e.features[0];
                if (!f) return;
                const id = f.id || (f.properties && f.properties.GEOID);
                if (id == null) return;
                if (hoveredId !== id) {
                    if (hoveredId !== null) {
                        map.setFeatureState({ source: 'swing-county-borders', id: hoveredId }, { hover: false });
                    }
                    hoveredId = id;
                    map.setFeatureState({ source: 'swing-county-borders', id: hoveredId }, { hover: true });
                }
                hoverPopup.setLngLat(e.lngLat).setHTML(countyHTML(f.properties || {})).addTo(map);
            });
            map.on('click', 'county_results', (e) => {
                const f = e.features && e.features[0];
                if (!f) return;
                const id = f.id || (f.properties && f.properties.GEOID);
                if (id == null) return;
                if (selectedId !== null && selectedId !== id) {
                    map.setFeatureState({ source: 'swing-county-borders', id: selectedId }, { selected: false });
                }
                const newSelected = selectedId === id ? null : id;
                if (newSelected === null) {
                    map.setFeatureState({ source: 'swing-county-borders', id: id }, { selected: false });
                } else {
                    map.setFeatureState({ source: 'swing-county-borders', id: id }, { selected: true });
                }
                selectedId = newSelected;
                new mapboxgl.Popup({ closeButton: true, offset: 12 })
                    .setLngLat(e.lngLat)
                    .setHTML(countyHTML(f.properties || {}))
                    .addTo(map);
            });

            
            

            scroller
                .setup({
                    step: '.step',
                    offset: 0.5,
                    progress: true
                })
                .onStepEnter(async response => {
                    var current_chapter = config.chapters.findIndex(chap => chap.id === response.element.id);
                    var chapter = config.chapters[current_chapter];

                    response.element.classList.add('active');
                    map[chapter.mapAnimation || 'flyTo'](chapter.location);

                    if (config.showMarkers) {
                        marker.setLngLat(chapter.location.center);
                    }
                    if (chapter.onChapterEnter.length > 0) {
                        chapter.onChapterEnter.forEach(setLayerOpacity);
                    }
                    if (chapter.callback) {
                        window[chapter.callback]();
                    }
                    if (chapter.rotateAnimation) {
                        map.once('moveend', () => {
                            const rotateNumber = map.getBearing();
                            map.rotateTo(rotateNumber + 180, {
                                duration: 30000, easing: function (t) {
                                    return t;
                                }
                            });
                        });
                    }
                    if (config.auto) {
                        var next_chapter = (current_chapter + 1) % config.chapters.length;
                        map.once('moveend', () => {
                            document.querySelectorAll('[data-scrollama-index="' + next_chapter.toString() + '"]')[0].scrollIntoView();
                        });
                    }
                })
                .onStepExit(response => {
                    var chapter = config.chapters.find(chap => chap.id === response.element.id);
                    response.element.classList.remove('active');
                    if (chapter.onChapterExit.length > 0) {
                        chapter.onChapterExit.forEach(setLayerOpacity);
                    }
                });


            if (config.auto) {
                document.querySelectorAll('[data-scrollama-index="0"]')[0].scrollIntoView();
            }
        });    

    </script>

</body>

</html>
